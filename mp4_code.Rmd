---
title: "Take Me Out to Which Ballgame?"
author: "Jay-Ho Chung, Brigitte Goeler-Slough, Nathan Ives"
date: "4/23/2018"
output: 
  html_document:
    code_folding: hide
    df_print: paged
    theme: spacelab
---
  
  For any baseball player, the highest individual achievement is induction into the Hall of Fame. This is an exclusive club, with 323 inductees, including 226 former Major League Baseball players and 35 players and executives from the Negro League. For our last mini-project, we thought it would be interesting to use data from the lahman data set to explore statistical differences between those inducted in the Hall of Fame and those who were on the cusp, but at least as of yet have not made it. Baseball as a game has changed considerably in the time it has been played, with a greater emphasis being placed on hitting home runs for position players, while strikeouts are at an all-time high. Additionally, as we'll see later on, the game has been tainted somewhat by the steroids era. Our hope in looking at the statistics was to provide some suggestions about certain players that should be inducted into the Hall of Fame among those who have not yet made it.
  The first thing we did was to spend considerable time working with SQL to narrow down our queries. We wanted to create objects showing meaningful statistics both for pitchers and hitters currently in the Hall of Fame, as well as similar objects for those pitchers and hitters who have not yet made the Hall of Fame. The batters and pitchers inducted in the Hall of Fame are stored as `hitters` and `pitchers` respectively, while those who have not been inducted are stored as `batters_not_inducted` and `pitchers_not_inducted`.

```{r (Packages), warning = FALSE, message = FALSE}
library(mdsr)
library(RMySQL)
library(tidyverse)
library(plotly)
library(ggrepel)
```

```{r (Connecting to the Database)}
db <- dbConnect_scidb(dbname = "lahman")
```

```{r (Pitchers), warning = FALSE}
pitchers <- db %>% 
  dbGetQuery(
    "SELECT hof.playerID, hof.yearID, nameFirst, nameLast, 
    sum(G) as G, sum(pi.GS) as GS, sum(IPouts/3) as IP, 
    sum(CG) as CG, sum(SHO) as SHO, sum(SV) as SV, sum(W) as W,
    sum(L) as L, sum(H) as H, sum(BB) as BB, sum(ER) as ER,
    sum(SO) as SO, ((sum(ER) / (sum(IPouts)/3)) * 9) as ERA, 
    ((sum(H) + sum(BB)) / (sum(IPouts) / 3)) as WHIP
    FROM HallOfFame hof
    JOIN Master ma ON ma.playerID = hof.playerID
    JOIN Pitching pi ON pi.playerID = hof.playerID
    WHERE hof.inducted = 'Y'
    GROUP BY hof.playerID
HAVING G > 100;"
  )
pitchers
```

```{r (Hitters), warning = FALSE}
hitters <- db %>% 
  dbGetQuery("SELECT hof.playerID, hof.yearID, nameFirst,
              nameLast, sum(AB) as AB, sum(R) as R, sum(H) as H,
              sum(2B) as 2B, sum(3B) as 3B, sum(HR) as HR,
              sum(RBI) as RBI, sum(SB) as SB, 
              (sum(H) / sum(AB)) as AVG
              FROM HallOfFame hof
              JOIN Master ma ON ma.playerID = hof.playerID
              JOIN Batting ba ON ba.playerID = hof.playerID
              WHERE hof.inducted = 'Y'
              GROUP BY hof.playerID
              HAVING AB > 2000;")
hitters
```

```{r (not inducted), warning = FALSE}
not_inducted <- db %>%
  dbGetQuery("SELECT playerID, yearid, ballots, needed, votes, inducted, 
sum(inducted = 'Y') as indct
FROM HallOfFame
GROUP BY playerID
HAVING indct = 0")
not_inducted
```

```{r (batteres not inducted), warning = FALSE}
batters_not_inducted <- db %>% 
  dbGetQuery("SELECT hof.playerID, nameLast, nameFirst,
              count(DISTINCT hof.yearID) as num_ballots,
              min(hof.yearid) AS first_year, ballots, needed,
              votes, inducted, max(votes / ballots) as PCT,
              sum(AB) / count(DISTINCT hof.yearID) as AB, 
              sum(R) / count(DISTINCT hof.yearID) as R, 
              sum(H) / count(DISTINCT hof.yearID) as H,
              sum(2B) / count(DISTINCT hof.yearID) as 2B, 
              sum(3B) / count(DISTINCT hof.yearID) as 3B, 
              sum(HR) / count(DISTINCT hof.yearID) as HR,
              sum(RBI) / count(DISTINCT hof.yearID) as RBI,
              sum(SB) / count(DISTINCT hof.yearID) as SB, 
              (sum(H) / sum(AB)) as AVG,
              sum(inducted = 'Y') as indct
FROM HallOfFame as hof
JOIN Batting ba ON ba.playerID = hof.playerID
JOIN Master ma ON ma.playerID = hof.playerID
WHERE hof.yearid > 1979
GROUP BY hof.playerID
HAVING indct = 0
  AND AB > 4000
  AND PCT > 0.2
ORDER BY PCT desc;")

batters_not_inducted
```

```{r warning = FALSE}
pitchers_not_inducted <- db %>%
  dbGetQuery("SELECT hof.playerID, hof.yearID, ma.nameFirst, ma.nameLast, count(DISTINCT hof.yearID) as num_ballots, hof.ballots , hof.needed , hof.votes , max(votes/ballots) as PCT , hof.inducted,
    sum(inducted = 'Y') as indct ,sum(G)/(count(DISTINCT hof.yearID)) as G, sum(GS)/(count(DISTINCT hof.yearID)) as GS, sum(IPouts/3)/(count(DISTINCT hof.yearID)) as IP, 
    sum(CG) / (count(DISTINCT hof.yearID)) as CG, sum(SHO) / (count(DISTINCT hof.yearID)) as SHO, sum(SV) / (count(DISTINCT hof.yearID)) as SV, sum(W) / (count(DISTINCT hof.yearID)) as W,
    sum(L) / (count(DISTINCT hof.yearID)) as L, sum(H) / (count(DISTINCT hof.yearID)) as H, sum(BB) / (count(DISTINCT hof.yearID)) as BB, sum(ER) / (count(DISTINCT hof.yearID)) as ER,
    sum(SO)/(count(DISTINCT hof.yearID)) as SO, ((sum(ER) / (sum(IPouts)/3)) * 9) as ERA, 
    ((sum(H) + sum(BB)) / (sum(IPouts) / 3)) as WHIP 
FROM lahman.HallOfFame AS hof
JOIN lahman.Master AS ma on ma.playerID = hof.playerID
JOIN lahman.Pitching AS pi on pi.playerID = hof.playerID
GROUP BY ma.playerID
HAVING indct = 0
  AND PCT > 0.2
  AND G > 100
ORDER BY PCT desc;")

pitchers_not_inducted
# Use save() to save it as a .rda and then load() it later w/ eval = FALSE
```

```{r message = FALSE, warning = FALSE}
all_hitters <- hitters %>% 
  full_join(batters_not_inducted)

all_pitchers <- pitchers %>% 
  full_join(pitchers_not_inducted)
```

```{r}
ggplot(all_hitters, aes(x = AVG, y = HR)) +
  geom_point() +
  scale_y_continuous(limits = c(0, 800))
```

```{r}
ggplot(all_pitchers, aes(x = ERA, y = W)) +
  geom_point()
```

```{r message = FALSE}
pp <- ggplot(pitchers, aes(x = ERA, y = W)) + 
  geom_point(text = paste(nameFirst, " ", nameLast)) +
  ggtitle("Pitchers Inducted") +
  xlim(1.5,4) +
  ylim(0,520)
ggplotly(pp)
```

```{r}
pnp <- ggplot(pitchers_not_inducted, aes(x = ERA, y = W)) + 
  geom_point(aes(text = paste(nameFirst, " ", nameLast))) +
  ggtitle("Pitchers not Inducted") +
  xlim(1.5,4) +
  ylim(0,520)
ggplotly(pnp)
```

```{r}
ggplot(pitchers_not_inducted, aes(x = ERA, y = W)) + 
  geom_point() +
  geom_label_repel(
    aes(label = nameLast)) +
  ggtitle("Pitchers not Inducted") +
  xlim(1.5,4) +
  ylim(0,520)
```

```{r message = FALSE}
hp <- ggplot(hitters, aes(x = AVG, y = HR)) +
  geom_point(aes(text = paste(nameFirst, " ", nameLast))) +
  ggtitle("Hitters Inducted") +
  xlim(.15, .4) +
  ylim(0,850)
ggplotly(hp)

bnp <- ggplot(batters_not_inducted, aes(x = AVG, y = HR)) +
  geom_point(aes(text = paste(nameFirst, " ", nameLast))) +
  ggtitle("Hitters not Inducted") +
  xlim(.15, .4) +
  ylim(0,850)
ggplotly(bnp)
```

```{r warning = FALSE, message = FALSE}
both_hitters <- db %>% 
  dbGetQuery("SELECT hof.playerID, nameLast, nameFirst,
              count(DISTINCT hof.yearID) as num_ballots,
              min(hof.yearid) AS first_year, ballots, needed,
              votes, inducted, max(votes / ballots) as PCT,
              sum(AB) / count(DISTINCT hof.yearID) as AB, 
              sum(R) / count(DISTINCT hof.yearID) as R, 
              sum(H) / count(DISTINCT hof.yearID) as H,
              sum(2B) / count(DISTINCT hof.yearID) as 2B, 
              sum(3B) / count(DISTINCT hof.yearID) as 3B, 
              sum(HR) / count(DISTINCT hof.yearID) as HR,
              sum(RBI) / count(DISTINCT hof.yearID) as RBI,
              sum(SB) / count(DISTINCT hof.yearID) as SB, 
              (sum(H) / sum(AB)) as AVG
FROM HallOfFame as hof
JOIN Batting ba ON ba.playerID = hof.playerID
JOIN Master ma ON ma.playerID = hof.playerID
WHERE hof.yearid > 1979
GROUP BY hof.playerID
HAVING AB > 4000
  AND PCT > 0.2
ORDER BY PCT desc;")

bhp <- ggplot(both_hitters, aes(x = AVG, y = HR, colour = inducted)) +
  geom_point(data = both_hitters, text = paste(nameFirst, " ", nameLast)) +
  ggtitle("All Hitters") +
  xlim(0, .4) +
  ylim(.15,850)
ggplotly(bhp)

```

```{r warning = FALSE, message = FALSE}
both_pitchers <- db %>% 
  dbGetQuery("SELECT sum(inducted = 'Y') as indct, hof.playerID, hof.yearID, ma.nameFirst, ma.nameLast, count(DISTINCT hof.yearID) as num_ballots, hof.ballots , hof.needed , hof.votes , max(votes/ballots) as PCT , hof.inducted,
    sum(G)/(count(DISTINCT hof.yearID)) as G, sum(GS)/(count(DISTINCT hof.yearID)) as GS, sum(IPouts/3)/(count(DISTINCT hof.yearID)) as IP, 
    sum(CG) / (count(DISTINCT hof.yearID)) as CG, sum(SHO) / (count(DISTINCT hof.yearID)) as SHO, sum(SV) / (count(DISTINCT hof.yearID)) as SV, sum(W) / (count(DISTINCT hof.yearID)) as W,
    sum(L) / (count(DISTINCT hof.yearID)) as L, sum(H) / (count(DISTINCT hof.yearID)) as H, sum(BB) / (count(DISTINCT hof.yearID)) as BB, sum(ER) / (count(DISTINCT hof.yearID)) as ER,
    sum(SO)/(count(DISTINCT hof.yearID)) as SO, ((sum(ER) / (sum(IPouts)/3)) * 9) as ERA, 
    ((sum(H) + sum(BB)) / (sum(IPouts) / 3)) as WHIP
FROM lahman.HallOfFame AS hof
JOIN lahman.Master AS ma on ma.playerID = hof.playerID
JOIN lahman.Pitching AS pi on pi.playerID = hof.playerID
GROUP BY ma.playerID
HAVING PCT > 0.2
  AND G > 100
ORDER BY PCT desc;")

bpp <- ggplot(both_pitchers, aes(x = ERA, y = W, color = inducted)) + 
  geom_point(data = both_pitchers, text = paste(nameFirst, " ", nameLast)) +
  ggtitle("All Pitchers") +
  xlim(1.5,4) +
  ylim(0,520)

ggplotly(bpp)
```

```{r}
not_inducted_all_star_appearances <- db %>%
  dbGetQuery("SELECT tab1.playerID, tab1.nameFirst, tab1.nameLast, tab1.total_games, tab1.firstyear, tab1.lastyear, tab1.diff,
HallOfFame.inducted
FROM HallOfFame, 
((SELECT af.playerID, nameFirst, nameLast, 
sum(af.GP) as total_games, GP,
min(af.yearID) as firstyear, max(af.yearID) as lastyear, max(af.yearID)-min(af.yearID) as diff
FROM lahman.AllstarFull as af
JOIN Master as ms ON ms.playerID = af.playerID
GROUP BY af.playerID
ORDER BY GP desc, total_games desc) as tab1)
WHERE HallOfFame.playerID=tab1.playerID and HallOfFame.inducted!='Y'
GROUP BY playerID order by total_games desc;")
```

```{r}
both_all_star_appearances <- db %>%
  dbGetQuery("SELECT tab1.playerID, tab1.nameFirst, tab1.nameLast, tab1.total_games, tab1.firstyear, tab1.lastyear, tab1.diff,
HallOfFame.inducted
FROM HallOfFame, 
((SELECT af.playerID, nameFirst, nameLast, 
sum(af.GP) as total_games, GP,
min(af.yearID) as firstyear, max(af.yearID) as lastyear, max(af.yearID)-min(af.yearID) as diff
FROM lahman.AllstarFull as af
JOIN Master as ms ON ms.playerID = af.playerID
GROUP BY af.playerID
ORDER BY GP desc, total_games desc) as tab1)
WHERE HallOfFame.playerID=tab1.playerID
GROUP BY playerID order by total_games desc;")
both_all_star_appearances
```

```{r}
ggplot(data = both_all_star_appearances, aes(x = nameLast, y = total_games, color = inducted)) +
  geom_point()
```

