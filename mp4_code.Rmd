---
title: "Take Me Out to Which Ballgame?"
author: "Jay-Ho Chung, Brigitte Goeler-Slough, Nathan Ives"
date: "4/23/2018"
output: 
  html_document:
    code_folding: hide
    df_print: paged
    theme: spacelab
---
  
  For any baseball player, the highest individual achievement is induction into the Hall of Fame. This is an exclusive club, with 323 inductees, including 226 former Major League Baseball players and 35 players and executives from the Negro League. For our last mini-project, we thought it would be interesting to use data from the lahman data set to explore statistical differences between those inducted in the Hall of Fame and those who were on the cusp, but at least as of yet have not made it. Baseball as a game has changed considerably in the time it has been played, with a greater emphasis being placed on hitting home runs for position players, while strikeouts are at an all-time high. Additionally, as we'll see later on, the game has been tainted somewhat by the steroids era. Our hope in looking at the statistics was to provide some suggestions about certain players that should be inducted into the Hall of Fame among those who have not yet made it.
  The first thing we did was to spend considerable time working with SQL to narrow down our queries. We wanted to create objects showing meaningful statistics both for pitchers and hitters currently in the Hall of Fame, as well as similar objects for those pitchers and hitters who have not yet made the Hall of Fame. The batters and pitchers inducted in the Hall of Fame are stored as `hitters` and `pitchers` respectively, while those who have not been inducted are stored as `batters_not_inducted` and `pitchers_not_inducted`.
  When we look at the graph with All Hitters, a couple things stand out. First, it seems that there is no clear distinction between hitters who are in the Hall of Fame based on AVG and HRs. For instance, it does not appear that those hitters who hit for a higher AVG or more HRs are definitely in the Hall of Fame. Delving in deeper and investigating who the certain players are who haven't been inducted, we see that many of the ones who have the strongest statistical resumes and haven't been inducted are ones with clear connections to performance enhancing drugs (PEDs). For instance, the three highest HR totals for those not inducted in the Hall of Fame according to our search are Barry Bonds, Mark McGwire, and Manny Ramirez, all of whom have been linked to PEDs in the past. This adds an interesting element to the work we've been doing in that simply looking at the statistics is not enough. A greater knowledge that goes beyond the numbers is needed to understand why certain of these players are not in the Hall of Fame. As we've talked about before in this class, an important job of data scientists is to be culturally aware and think deeply about trends or patterns observed in the data, like with racial profiling done by police departments in certain neighborhoods.

```{r (Packages), warning = FALSE, message = FALSE}
library(mdsr)
library(RMySQL)
library(tidyverse)
library(plotly)
library(ggrepel)
library(gridExtra)
library(ggthemes)
```

```{r (Connecting to the Database)}
db <- dbConnect_scidb(dbname = "lahman")
```

```{r (Pitchers), warning = FALSE}
pitchers <- db %>% 
  dbGetQuery(
    "SELECT hof.playerID, hof.yearID, nameFirst, nameLast, 
    sum(G) as G, sum(pi.GS) as GS, sum(IPouts/3) as IP, 
    sum(CG) as CG, sum(SHO) as SHO, sum(SV) as SV, sum(W) as W,
    sum(L) as L, sum(H) as H, sum(BB) as BB, sum(ER) as ER,
    sum(SO) as SO, ((sum(ER) / (sum(IPouts)/3)) * 9) as ERA, 
    ((sum(H) + sum(BB)) / (sum(IPouts) / 3)) as WHIP , hof.inducted
    FROM HallOfFame hof
    JOIN Master ma ON ma.playerID = hof.playerID
    JOIN Pitching pi ON pi.playerID = hof.playerID
    WHERE hof.inducted = 'Y'
    GROUP BY hof.playerID
HAVING G > 100;"
  )
pitchers
```

```{r (Hitters), warning = FALSE}
hitters <- db %>% 
  dbGetQuery("SELECT hof.playerID, hof.yearID, nameFirst,
              nameLast, sum(AB) as AB, sum(R) as R, sum(H) as H,
              sum(2B) as 2B, sum(3B) as 3B, sum(HR) as HR,
              sum(RBI) as RBI, sum(SB) as SB, 
              (sum(H) / sum(AB)) as AVG , hof.inducted
              FROM HallOfFame hof
              JOIN Master ma ON ma.playerID = hof.playerID
              JOIN Batting ba ON ba.playerID = hof.playerID
              WHERE hof.inducted = 'Y'
              GROUP BY hof.playerID
              HAVING AB > 2000;")
hitters
```

```{r (not inducted), warning = FALSE}
not_inducted <- db %>%
  dbGetQuery("SELECT playerID, yearid, ballots, needed, votes, inducted, 
sum(inducted = 'Y') as indct
FROM HallOfFame
GROUP BY playerID
HAVING indct = 0")
not_inducted
```

```{r (Batters not inducted), warning = FALSE}
batters_not_inducted <- db %>% 
  dbGetQuery("SELECT hof.playerID, nameLast, nameFirst,
              count(DISTINCT hof.yearID) as num_ballots,
              min(hof.yearid) AS first_year, ballots, needed,
              votes, inducted, max(votes / ballots) as PCT,
              sum(AB) / count(DISTINCT hof.yearID) as AB, 
              sum(R) / count(DISTINCT hof.yearID) as R, 
              sum(H) / count(DISTINCT hof.yearID) as H,
              sum(2B) / count(DISTINCT hof.yearID) as 2B, 
              sum(3B) / count(DISTINCT hof.yearID) as 3B, 
              sum(HR) / count(DISTINCT hof.yearID) as HR,
              sum(RBI) / count(DISTINCT hof.yearID) as RBI,
              sum(SB) / count(DISTINCT hof.yearID) as SB, 
              (sum(H) / sum(AB)) as AVG,
              sum(inducted = 'Y') as indct
FROM HallOfFame as hof
JOIN Batting ba ON ba.playerID = hof.playerID
JOIN Master ma ON ma.playerID = hof.playerID
WHERE hof.yearid > 1979
GROUP BY hof.playerID
HAVING indct = 0
  AND AB > 4000
  AND PCT > 0.2
ORDER BY PCT desc;")

batters_not_inducted
```

```{r warning = FALSE}
pitchers_not_inducted <- db %>%
  dbGetQuery("SELECT hof.playerID, hof.yearID, ma.nameFirst, ma.nameLast, count(DISTINCT hof.yearID) as num_ballots, hof.ballots , hof.needed , hof.votes , max(votes/ballots) as PCT , hof.inducted,
    sum(inducted = 'Y') as indct ,sum(G)/(count(DISTINCT hof.yearID)) as G, sum(GS)/(count(DISTINCT hof.yearID)) as GS, sum(IPouts/3)/(count(DISTINCT hof.yearID)) as IP, 
    sum(CG) / (count(DISTINCT hof.yearID)) as CG, sum(SHO) / (count(DISTINCT hof.yearID)) as SHO, sum(SV) / (count(DISTINCT hof.yearID)) as SV, sum(W) / (count(DISTINCT hof.yearID)) as W,
    sum(L) / (count(DISTINCT hof.yearID)) as L, sum(H) / (count(DISTINCT hof.yearID)) as H, sum(BB) / (count(DISTINCT hof.yearID)) as BB, sum(ER) / (count(DISTINCT hof.yearID)) as ER,
    sum(SO)/(count(DISTINCT hof.yearID)) as SO, ((sum(ER) / (sum(IPouts)/3)) * 9) as ERA, 
    ((sum(H) + sum(BB)) / (sum(IPouts) / 3)) as WHIP 
FROM lahman.HallOfFame AS hof
JOIN lahman.Master AS ma on ma.playerID = hof.playerID
JOIN lahman.Pitching AS pi on pi.playerID = hof.playerID
GROUP BY ma.playerID
HAVING indct = 0
  AND PCT > 0.2
  AND G > 100
ORDER BY PCT desc;")

pitchers_not_inducted
# Use save() to save it as a .rda and then load() it later w/ eval = FALSE
```

```{r message = FALSE, warning = FALSE}
all_hitters <- hitters %>% 
  full_join(batters_not_inducted)

all_pitchers <- pitchers %>% 
  full_join(pitchers_not_inducted)
```

  Exploring the Hall of Fame and how the standards for entry may have changed over time, we looked at how career statistics in terms of HR, AVG, SB, and SLG have changed for those inducted over time. Something to note is that for the most part, HRs have increased while AVG and SBs have decreased. There certainly has been a push in recent years with a focus on launch angle to encourage hitters to swing for the fences in a strategy that hasn't been seen to this extent in baseball before. This means more strikeouts and more home runs for many hitters. Players like Mark Reynolds, Chris Davis, and Logan Morrison are poster childs for this revolution. That being said, the trends in the Hall of Fame statistics probably don't even fully represent this change because of the lag between when a player's career is over and five years later when they can first be inducted. So this strategic change may be even more readily apparent in a decade or two.
  Moving on to the pitchers, we similarly looked at statistical trends in Hall of Fame inductees over time. The most interesting findings are that ERA and Strikeouts has generally increased, and that complete games have decreased. As mentioned in the paragraph above, many hitters have changed their mentality at the plate to try to hit more home runs, at the expense of striking out more. With ERA, the bump in earned runs given up by pitchers may be explained by the fact that hitters have more strength and conditioning than ever before, as well as the help of advanced scouting to look for even the smallest tell in a pitcher's form. Complete games have steadily decreased amonth those inducted to the Hall of Fame. Starting pitchers these days are much less likely to go deep into games, partially because it is generally believe that they expend more effort every pitch/inning, and because the composition of teams is such that there are high quality relievers to take over the game in late innings so that starters don't have to pitch quite so many innings. Another reason is the wear and tear pitching so fast has on arms. The increased number of reconstructive surgeries like Tommy John surgery also play into the fewer number of complete games being thrown.
  
```{r}
hitters <- hitters %>% 
  mutate(SLG = ((hitters$'2B' * 2) + (hitters$'3B' * 3) + (hitters$'HR' * 4) + (hitters$'H' - hitters$'2B' - hitters$'3B' - hitters$'HR')) / hitters$'AB')
```

```{r (How statistics have changed for HOF batters)}
hit_2 <- ggplot(hitters, aes(x = yearID, y = HR)) +
  geom_point() +
  stat_smooth() +
  theme_economist() 
hit_3 <- ggplot(hitters, aes(x = yearID, y = AVG)) +
  geom_point() +
  stat_smooth() +
  theme_economist() 
hit_4 <- ggplot(hitters, aes(x = yearID, y = SB)) +
  geom_point() +
  stat_smooth() + 
  theme_economist() 
hit_5 <- ggplot(hitters, aes(x = yearID, y = SLG)) +
  geom_point() +
  stat_smooth() + 
  theme_economist() 


hit_2 <- ggplotly(hit_2)
hit_3 <- ggplotly(hit_3)
hit_4 <- ggplotly(hit_4)
hit_5 <- ggplotly(hit_5)

subplot(hit_2, hit_3, hit_4 , hit_5 , nrows = 2, margin = 0.04, heights = c(0.6, 0.4))
```

```{r}
pit_2 <- ggplot(pitchers, aes(x = yearID, y = W)) +
  geom_point() +
  stat_smooth()
pit_3 <- ggplot(pitchers, aes(x = yearID, y = SO)) +
  geom_point() +
  stat_smooth()
pit_4 <- ggplot(pitchers, aes(x = yearID, y = ERA)) +
  geom_point() +
  stat_smooth()
pit_5 <- ggplot(pitchers, aes(x = yearID, y = CG)) +
  geom_point() +
  stat_smooth()
grid.arrange(pit_2, pit_3, pit_4, pit_5, ncol = 2)
```


```{r}
ggplot(all_hitters, aes(x = AVG, y = HR)) +
  geom_point() +
  scale_y_continuous(limits = c(0, 800))
```

```{r}
ggplot(all_pitchers, aes(x = ERA, y = W)) +
  geom_point()
```

```{r message = FALSE, eval = FALSE}
pp <- ggplot(pitchers, aes(x = ERA, y = W)) + 
  geom_point(text = paste(nameFirst, " ", nameLast)) +
  ggtitle("Pitchers Inducted") +
  xlim(1.5,4) +
  ylim(0,520)
ggplotly(pp)

plot_ly(pitchers, x = ~ERA, y = ~W, type = 'scatter', mode = 'markers',
        text = ~paste('Player: ', nameFirst , "" , nameLast )) %>%
          layout(title = "Pitchers Inducted" , xaxis = era_x , yaxis = wins_y)
# Jay-Ho code is plot_ly
```

```{r (Non-Inducted Pitchers Plot)}
# Defining a font, this is from the plotly package. We wanted an interactive graphic
f <- list(
  family = "Courier New, monospace",
  size = 18,
  color = "#7f7f7f"
) 

# Choosing the x-axis
era_x <- list(
  title = "ERA",
  titlefont = f
)

# Choosing the y-axis
wins_y <- list(
  title = "W",
  titlefont = f
)

# Plotting the non-inducted pitchers
plot_ly(pitchers_not_inducted, x = ~ERA, y = ~W, type = 'scatter', mode = 'markers',
        text = ~paste('Player: ', nameFirst , "" , nameLast )) %>%
          layout(title = "Pitchers Not Inducted" , xaxis = era_x , yaxis = wins_y)
```

```{r (HOF Pitchers)}
# Plotting for hof_pitchers
plot_ly(pitchers, x = ~ERA, y = ~W, type = 'scatter', mode = 'markers',
        text = ~paste('Player: ', nameFirst , "" , nameLast )) %>%
          layout(title = "Pitchers Not Inducted" , xaxis = era_x , yaxis = wins_y)
```

```{r}
ggplot(pitchers_not_inducted, aes(x = ERA, y = W)) + 
  geom_point() +
  geom_label_repel(
    aes(label = nameLast)) +
  ggtitle("Pitchers not Inducted") +
  xlim(1.5,4) +
  ylim(0,520)
```

```{r message = FALSE}
h_1 <- plot_ly(hitters, x = ~AVG, y = ~HR, type = 'scatter', mode = 'markers',
        text = ~paste('Player: ', nameFirst , "" , nameLast )) %>%
          layout(title = "Batters Inducted" , xaxis = avg_x , yaxis = hr_y)

h_2 <- plot_ly(batters_not_inducted, x = ~AVG, y = ~HR, type = 'scatter', mode = 'markers',
        text = ~paste('Player: ', nameFirst , "" , nameLast )) %>%
          layout(title = "Batter Not Inducted" , xaxis = avg_x , yaxis = hr_y)

h_arranged<- subplot(h_1 , h_2 , titleX = TRUE , titleY = TRUE) %>%
  layout(showlegend = FALSE , title = "Batters on Ballot")
ggplotly(bnp)

```

```{r warning = FALSE, message = FALSE}
both_hitters <- db %>% 
  dbGetQuery("SELECT hof.playerID, nameLast, nameFirst,
              count(DISTINCT hof.yearID) as num_ballots,
              min(hof.yearid) AS first_year, ballots, needed,
              votes, inducted, max(votes / ballots) as PCT,
              sum(AB) / count(DISTINCT hof.yearID) as AB, 
              sum(R) / count(DISTINCT hof.yearID) as R, 
              sum(H) / count(DISTINCT hof.yearID) as H,
              sum(2B) / count(DISTINCT hof.yearID) as 2B, 
              sum(3B) / count(DISTINCT hof.yearID) as 3B, 
              sum(HR) / count(DISTINCT hof.yearID) as HR,
              sum(RBI) / count(DISTINCT hof.yearID) as RBI,
              sum(SB) / count(DISTINCT hof.yearID) as SB, 
              (sum(H) / sum(AB)) as AVG
FROM HallOfFame as hof
JOIN Batting ba ON ba.playerID = hof.playerID
JOIN Master ma ON ma.playerID = hof.playerID
WHERE hof.yearid > 1979
GROUP BY hof.playerID
HAVING AB > 4000
  AND PCT > 0.2
ORDER BY PCT desc;")

bhp <- ggplot(both_hitters, aes(x = AVG, y = HR, colour = inducted)) +
  geom_point(data = both_hitters, text = paste(nameFirst, " ", nameLast)) +
  ggtitle("All Hitters") +
  xlim(0, .4) +
  ylim(.15,850)
ggplotly(bhp)

```

```{r warning = FALSE, message = FALSE}
both_pitchers <- db %>% 
  dbGetQuery("SELECT sum(inducted = 'Y') as indct, hof.playerID, hof.yearID, ma.nameFirst, ma.nameLast, count(DISTINCT hof.yearID) as num_ballots, hof.ballots , hof.needed , hof.votes , max(votes/ballots) as PCT , hof.inducted,
    sum(G)/(count(DISTINCT hof.yearID)) as G, sum(GS)/(count(DISTINCT hof.yearID)) as GS, sum(IPouts/3)/(count(DISTINCT hof.yearID)) as IP, 
    sum(CG) / (count(DISTINCT hof.yearID)) as CG, sum(SHO) / (count(DISTINCT hof.yearID)) as SHO, sum(SV) / (count(DISTINCT hof.yearID)) as SV, sum(W) / (count(DISTINCT hof.yearID)) as W,
    sum(L) / (count(DISTINCT hof.yearID)) as L, sum(H) / (count(DISTINCT hof.yearID)) as H, sum(BB) / (count(DISTINCT hof.yearID)) as BB, sum(ER) / (count(DISTINCT hof.yearID)) as ER,
    sum(SO)/(count(DISTINCT hof.yearID)) as SO, ((sum(ER) / (sum(IPouts)/3)) * 9) as ERA, 
    ((sum(H) + sum(BB)) / (sum(IPouts) / 3)) as WHIP
FROM lahman.HallOfFame AS hof
JOIN lahman.Master AS ma on ma.playerID = hof.playerID
JOIN lahman.Pitching AS pi on pi.playerID = hof.playerID
GROUP BY ma.playerID
HAVING PCT > 0.2
  AND G > 100
ORDER BY PCT desc;")

bpp <- ggplot(both_pitchers, aes(x = ERA, y = W, color = inducted)) + 
  geom_point(data = both_pitchers, text = paste(nameFirst, " ", nameLast)) +
  ggtitle("All Pitchers") +
  xlim(1.5,4) +
  ylim(0,520)

ggplotly(bpp)
```

```{r}
not_inducted_all_star_appearances <- db %>%
  dbGetQuery("SELECT tab1.playerID, tab1.nameFirst, tab1.nameLast, tab1.total_games, tab1.firstyear, tab1.lastyear, tab1.diff,
HallOfFame.inducted
FROM HallOfFame, 
((SELECT af.playerID, nameFirst, nameLast, 
sum(af.GP) as total_games, GP,
min(af.yearID) as firstyear, max(af.yearID) as lastyear, max(af.yearID)-min(af.yearID) as diff
FROM lahman.AllstarFull as af
JOIN Master as ms ON ms.playerID = af.playerID
GROUP BY af.playerID
ORDER BY GP desc, total_games desc) as tab1)
WHERE HallOfFame.playerID=tab1.playerID and HallOfFame.inducted!='Y'
GROUP BY playerID order by total_games desc;")
```

```{r}
both_all_star_appearances <- db %>%
  dbGetQuery("SELECT tab1.playerID, tab1.nameFirst, tab1.nameLast, tab1.total_games, tab1.firstyear, tab1.lastyear, tab1.diff,
HallOfFame.inducted
FROM HallOfFame, 
((SELECT af.playerID, nameFirst, nameLast, 
sum(af.GP) as total_games, GP,
min(af.yearID) as firstyear, max(af.yearID) as lastyear, max(af.yearID)-min(af.yearID) as diff
FROM lahman.AllstarFull as af
JOIN Master as ms ON ms.playerID = af.playerID
GROUP BY af.playerID
ORDER BY GP desc, total_games desc) as tab1)
WHERE HallOfFame.playerID=tab1.playerID
GROUP BY playerID order by total_games desc;")
both_all_star_appearances
```

```{r}
ggplot(data = both_all_star_appearances, aes(x = nameLast, y = total_games, color = inducted)) +
  geom_point()
```

